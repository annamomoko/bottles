<!DOCTYPE html>
<html>
<head>
  <title>Stone vs Plastic Detector</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>
  <style>
    video, canvas { border:1px solid #ccc; margin:5px; }
    button { margin:5px; padding:10px; }
  </style>
</head>
<body>
  <h2>Stone vs Plastic Detector</h2>

  <video id="webcam" autoplay playsinline width="224" height="224"></video>
  <div>
    <button onclick="addExample('stone')">Add Stone</button>
    <button onclick="addExample('plastic')">Add Plastic</button>
    <button onclick="saveModel()">💾 Save Model</button>
    <button onclick="loadDefaultModel()">🔄 Load Default Model</button>
  </div>

  <div id="load-container" style="display:none;">
    <p>No default model found. Load a JSON model manually:</p>
    <input type="file" id="loadFile" onchange="loadModel(event)">
  </div>

  <p id="status">Loading MobileNet...</p>
  <p id="prediction">Prediction: -</p>

  <script>
    let net;
    const classifier = knnClassifier.create();
    const webcamEl = document.getElementById('webcam');

    // ---------- Webcam Setup ----------
    async function setupWebcam() {
      return new Promise((resolve, reject) => {
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(stream => {
            webcamEl.srcObject = stream;
            webcamEl.addEventListener('loadeddata', () => resolve(), false);
          })
          .catch(err => reject(err));
      });
    }

    // ---------- Main App Loop ----------
    async function app() {
      net = await mobilenet.load();
      document.getElementById('status').innerText = "MobileNet loaded!";

      // Start prediction loop
      while (true) {
        const numClasses = classifier.getNumClasses();
        if (numClasses > 0) {
          const img = tf.browser.fromPixels(webcamEl);
          const activation = net.infer(img, 'conv_preds');
          const result = await classifier.predictClass(activation);

          // Build status text showing number of examples per class
          const counts = classifier.getClassExampleCount();
          let statusText = `Classes loaded: ${numClasses}\n`;
          Object.keys(counts).forEach(label => {
            statusText += ` - ${label}: ${counts[label]} samples\n`;
          });
          document.getElementById('status').innerText = statusText;

          document.getElementById('prediction').innerText =
            `Prediction: ${result.label} (confidence: ${(result.confidences[result.label]*100).toFixed(1)}%)`;
          img.dispose();
        } else {
          document.getElementById('status').innerText = "No training examples yet. Please add Stone or Plastic examples or load a model.";
          document.getElementById('prediction').innerText = "Prediction: -";
        }
        await tf.nextFrame();
      }
    }

    // ---------- Add Training Example ----------
    async function addExample(label) {
      const img = tf.browser.fromPixels(webcamEl);
      const activation = net.infer(img, 'conv_preds');
      classifier.addExample(activation, label);
      img.dispose();
      const counts = classifier.getClassExampleCount();
      document.getElementById('status').innerText =
        `Added example for: ${label} (total: ${counts[label]})`;
    }

    // ---------- Save Model ----------
    async function saveModel() {
      const dataset = classifier.getClassifierDataset();
      const datasetObj = {};
      Object.keys(dataset).forEach(key => {
        const data = dataset[key].dataSync();
        datasetObj[key] = { data: Array.from(data), shape: dataset[key].shape };
      });
      const jsonStr = JSON.stringify(datasetObj);
      const blob = new Blob([jsonStr], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "stone-plastic-model.json";
      a.click();
    }

    // ---------- Load Default Model from Server ----------
    async function loadDefaultModel() {
      try {
        const response = await fetch("stone-plastic-model.json", { cache: "no-cache" });
        if (!response.ok) throw new Error("Default model not found in folder");
        const datasetObj = await response.json();
        const tensorObj = {};
        Object.keys(datasetObj).forEach(key => {
          tensorObj[key] = tf.tensor(datasetObj[key].data, datasetObj[key].shape);
        });
        classifier.setClassifierDataset(tensorObj);
        document.getElementById('status').innerText = "✅ Default model loaded!";
        document.getElementById('load-container').style.display = 'none';
      } catch (e) {
        console.warn(e);
        document.getElementById('status').innerText = "⚠️ Could not load default model. Please train or manually load a model.";
        document.getElementById('load-container').style.display = 'block';
      }
    }

    // ---------- Load Model from File ----------
    async function loadModel(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const datasetObj = JSON.parse(e.target.result);
        const tensorObj = {};
        Object.keys(datasetObj).forEach(key => {
          tensorObj[key] = tf.tensor(datasetObj[key].data, datasetObj[key].shape);
        });
        classifier.setClassifierDataset(tensorObj);
        document.getElementById('status').innerText = "✅ Model loaded from file!";
        document.getElementById('load-container').style.display = 'none';
      };
      reader.readAsText(file);
    }

    // ---------- Initialize ----------
    setupWebcam().then(async () => {
      await loadDefaultModel();  // try auto-load first
      await app();               // then start prediction loop
    });
  </script>
</body>
</html>
